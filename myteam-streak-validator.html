<!DOCTYPE html>
<html>
<head>
  <link href=\"https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap\" rel=\"stylesheet\">
  <title>NBA 2K Tools Dashboard</title>
  <style>
    body { font-family: 'Montserrat', sans-serif; padding: 20px; background: #f9f9f9; color: #333; }
    textarea, input[type="text"], select { width: 100%; margin-bottom: 10px; }
    textarea { height: 150px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #eee; }
    .streak { background-color: #c6f6d5 !important; }
    .label-cell { font-weight: bold; color: #1a7f37; white-space: pre-wrap; }
    .team-match { background-color: #d0e6ff !important; }
    button { padding: 8px 12px; margin-top: 10px; background: #007BFF; color: white; border: none; cursor: pointer; margin-right: 10px; }
    button:hover { background: #0056b3; }
    .entry-row { display: flex; gap: 20px; align-items: flex-start; margin-bottom: 10px; flex-wrap: wrap; }
    .entry-group { flex: 1; min-width: 30%; display: none; flex-direction: column; justify-content: flex-start; }
    .entry-group.visible { display: flex; }
  </style>
</head>
<body>
  <a name="top"></a>
  <h2>NBA 2K Tools Dashboard</h2>

  <div class="entry-row">
    <div class="entry-group visible" id="mainGroup" style="display: flex;">
      <label><strong>Player's Gamertag:</strong></label>
      <input type="text" id="mainUser" placeholder="Player's Gamertag">
      <textarea id="rawData" placeholder="Paste Game History Data" oninput="checkForTeamEntries()"></textarea>
      <input type="text" id="gameModeFilter" placeholder="Game Mode Filter (optional, e.g. MyTEAM Park Co-Op)">
      <input type="number" id="minStreak" placeholder="Minimum Streak Length (optional, e.g. 3)" min="1">
    </div>

    <div class="entry-group" id="teamFields">
      <label><strong>Teammate #1:</strong></label>
      <input type="text" id="user1" placeholder="Teammate Gamertag 1">
      <textarea id="teamData1" placeholder="Paste Teammate 1 Game History"></textarea>
    </div>

    <div class="entry-group" id="teamFields2">
      <label><strong>Teammate #2:</strong></label>
      <input type="text" id="user2" placeholder="Teammate Gamertag 2">
      <textarea id="teamData2" placeholder="Paste Teammate 2 Game History"></textarea>
    </div>
  </div>

  <button onclick="analyzeData()">Validate</button>
  <button onclick="resetForm()">Reset</button>

  <details id="summary"><summary><strong>Streak Summary</strong></summary></details>
  <table id="dataTable" style="display:none;">
    <thead>
      <tr>
        <th>ID</th><th>Context</th><th>Start Time</th><th>Game</th><th>Save ID</th>
        <th>Milestone</th><th>Num Users</th><th>End Time</th><th>Minutes</th><th>Won</th><th>Streak Count</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    function parseGameData(raw) {
      return raw.split('\n').map(line => line.trim().split('\t')).filter(cols => cols.length >= 10);
    }

    function checkForTeamEntries() {
      const rawLines = parseGameData(document.getElementById('rawData').value);
      const show = rawLines.some(cols => parseInt(cols[6]) === 6);
      toggleTeamFields(show);
    }

    function toggleTeamFields(show) {
      document.getElementById('teamFields').classList.toggle('visible', show);
      document.getElementById('teamFields2').classList.toggle('visible', show);
    }

    function resetForm() {
      document.getElementById('mainUser').value = '';
      document.getElementById('rawData').value = '';
      document.getElementById('user1').value = '';
      document.getElementById('user2').value = '';
      document.getElementById('teamData1').value = '';
      document.getElementById('teamData2').value = '';
      document.getElementById('gameModeFilter').value = '';
      document.getElementById('minStreak').value = '';
      document.getElementById('summary').innerHTML = '';
      document.getElementById('dataTable').style.display = 'none';
      document.querySelector('#dataTable tbody').innerHTML = '';
      toggleTeamFields(false);
      
      // Remove all extra streak tables
      document.querySelectorAll('h3[id^="streak"], table, a[href="#top"]').forEach(el => {
        if (!el.closest('#dataTable')) el.remove();
      });
    }

    function analyzeData() {
      const rawLines = parseGameData(document.getElementById('rawData').value);
      const teamLines1 = parseGameData(document.getElementById('teamData1').value);
      const teamLines2 = parseGameData(document.getElementById('teamData2').value);
      const user1 = document.getElementById('user1').value;
      const user2 = document.getElementById('user2').value;
      const gameFilter = document.getElementById('gameModeFilter').value.toLowerCase();
      const minStreak = parseInt(document.getElementById('minStreak').value) || 2;
      const mainUser = document.getElementById('mainUser').value || 'Player';

      const tbody = document.querySelector('#dataTable tbody');
      tbody.innerHTML = '';
      let totalGames = 0, totalMinutes = 0, totalWins = 0;
      let winStreak = [], streakCount = 0;

      const filteredLines = rawLines.filter(cols => gameFilter === '' || cols[3].toLowerCase().includes(gameFilter));

      filteredLines.forEach((cols, idx) => {
        const won = parseInt(cols[9]);
        const numUsers = parseInt(cols[6]);
        const endTime = cols[7];
        const game = cols[3];

        const row = document.createElement('tr');
        cols.forEach(c => {
          const td = document.createElement('td');
          td.textContent = c;
          row.appendChild(td);
        });
        const labelTd = document.createElement('td');
        row.appendChild(labelTd);

        if (won === 1 && (winStreak.length === 0 || game === winStreak[0].game)) {
          winStreak.push({ row, endTime, game });
        } else {
          if (winStreak.length >= minStreak) {
            streakCount++;
            winStreak.forEach(entry => {
              entry.row.classList.add('streak');
              let label = `Streak ${streakCount} (${winStreak.length} Wins)`;
              const match1 = teamLines1.find(t => t[7] === entry.endTime && parseInt(t[9]) === 1);
              const match2 = teamLines2.find(t => t[7] === entry.endTime && parseInt(t[9]) === 1);
              if (parseInt(entry.row.children[6].textContent) === 6 && match1 && match2) {
                entry.row.classList.add('team-match');
                label += `\nShared with ${user1} & ${user2}`;
              }
              entry.row.id = `streak${streakCount}`;
              entry.row.children[10].textContent = label;
              entry.row.children[10].classList.add('label-cell');
              tbody.appendChild(entry.row);
            });
          } else {
            winStreak.forEach(entry => tbody.appendChild(entry.row));
          }
          winStreak = [];
          tbody.appendChild(row);
        }

        totalGames++;
        totalMinutes += parseInt(cols[8]);
        totalWins += won;
      });

      if (winStreak.length >= minStreak) {
        streakCount++;
        winStreak.forEach(entry => {
          entry.row.classList.add('streak');
          let label = `Streak ${streakCount} (${winStreak.length} Wins)`;
          const match1 = teamLines1.find(t => t[7] === entry.endTime && parseInt(t[9]) === 1);
          const match2 = teamLines2.find(t => t[7] === entry.endTime && parseInt(t[9]) === 1);
          if (parseInt(entry.row.children[6].textContent) === 6 && match1 && match2) {
            entry.row.classList.add('team-match');
            label += `\nShared with ${user1} & ${user2}`;
          }
          entry.row.id = `streak${streakCount}`;
          entry.row.children[10].textContent = label;
          entry.row.children[10].classList.add('label-cell');
          tbody.appendChild(entry.row);
        });
      }

      document.getElementById('dataTable').style.display = 'table';
      document.getElementById('summary').innerHTML = '';

      let streakSummaries = '';
      let currentStreak = [];

      filteredLines.forEach((cols, idx) => {
        const won = parseInt(cols[9]);
        const game = cols[3];
        const date = cols[2].split(' ')[0];
        const endTime = cols[7];

        if (won === 1 && (currentStreak.length === 0 || game === currentStreak[0].game)) {
          currentStreak.push({ date, game, endTime });
        }

        const isEnd = (won !== 1 || idx === filteredLines.length - 1);
        if (isEnd && currentStreak.length >= minStreak) {
          const streakDate = currentStreak[0].date;
          const streakGame = currentStreak[0].game;
          let teammates = [];

          if (user1 && teamLines1.find(t => currentStreak.some(cs => t[7] === cs.endTime))) teammates.push(user1);
          if (user2 && teamLines2.find(t => currentStreak.some(cs => t[7] === cs.endTime))) teammates.push(user2);

          const teammateStr = teammates.length > 0 ? ` with ${teammates.join(' & ')}` : '';
          streakSummaries += `<p><a href="#streak${streakCount}">On ${streakDate}, ${mainUser} had a ${currentStreak.length}-game win streak in ${streakGame}${teammateStr}.</a></p>`;
        }

        if (isEnd) currentStreak = [];
      });

      document.getElementById('summary').innerHTML += streakSummaries;

      const streakMap = new Map();
      document.querySelectorAll('.streak').forEach(row => {
        const label = row.children[10].textContent;
        if (!streakMap.has(label)) streakMap.set(label, []);
        streakMap.get(label).push(row.cloneNode(true));
      });

      let streakIndex = 1;
      streakMap.forEach((rows, label) => {
        const isShared = rows.some(r => r.classList.contains('team-match'));
        if (!isShared && (user1 || user2)) return;

        const firstRow = rows[0];
        const streakDate = firstRow.children[2].textContent.split(' ')[0];
        const streakGame = firstRow.children[3].textContent;
        const streakWins = rows.length;

        const title = document.createElement('h3');
        title.id = `streak${streakIndex}`;
        title.textContent = `${streakDate} ${streakGame} - ${streakWins} Win Streak`;

        const table = document.createElement('table');
        table.innerHTML = document.querySelector('#dataTable thead').outerHTML;
        const tbody = document.createElement('tbody');
        rows.forEach(r => tbody.appendChild(r));
        table.appendChild(tbody);

        const back = document.createElement('a');
        back.href = '#top';
        back.textContent = 'Back to top';
        back.style.display = 'block';
        back.style.marginTop = '10px';

        document.body.appendChild(title);
        document.body.appendChild(table);
        document.body.appendChild(back);

        streakIndex++;
      });
    }
  </script>
</body>
</html>
