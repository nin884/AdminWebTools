<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Web Audit</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Montserrat', sans-serif; margin: 20px; }
    textarea { width: 100%; height: 200px; font-family: monospace; padding: 10px; box-sizing: border-box; }
    button, select, input { margin: 2px; padding: 6px; font-size: 14px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f4f4f4; }
    #tableContainer, #discrepancyContainer { overflow-x: auto; margin-bottom: 20px; }
  </style>
</head>
<body>
  <h2>Admin Web Audit</h2>
  <textarea id="logData" placeholder="Paste log data here or drop a text file..."></textarea>
  <br>
  <button id="parseBtn">Parse Data</button>
  <div id="tableContainer"></div>
  <h3>Discrepancies</h3>
  <div id="counts">
    Major Discrepancies: <span id="majorCount">0</span> |
    Minor Discrepancies: <span id="minorCount">0</span>
  </div>
  <button id="exportBtn">Export to Excel</button>
  <div id="discrepancyContainer"></div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const textarea = document.getElementById('logData');
      const parseBtn = document.getElementById('parseBtn');
      const exportBtn = document.getElementById('exportBtn');
      const tableContainer = document.getElementById('tableContainer');
      const discrepancyContainer = document.getElementById('discrepancyContainer');
      const majorCountEl = document.getElementById('majorCount');
      const minorCountEl = document.getElementById('minorCount');

      let headers = [];
      const discrepancyOptions = ['', 'Minor', 'Major'];
      const issueOptions = ['', 'Wrong Tier VC added', 'More than 50K VC added without approval',
        'VC/MT/Items added without AT note',
        'MyTeam cards/MyCareer items/Other No-Currency items added not noted with a ticket',
        'Other actions in AT without note', 'Wrong MG provided',
        'Kick off account without AT note', 'Cloned file without AT note',
        'Agent missed PMVC 1st Party Escalation'];
      const locationOptions = ['', '5CA', 'Vegas Day', 'Vegas Swing', 'Vegas Weekend', 'Chengdu Day', 'Chengdu Weekend', 'Madrid', 'Player Advocacy'];

      function updateCounts() {
        let major = 0, minor = 0;
        const table = discrepancyContainer.querySelector('table');
        if (!table) { majorCountEl.textContent = '0'; minorCountEl.textContent = '0'; return; }
        table.querySelectorAll('tbody tr').forEach(r => {
          const typeCell = r.cells[headers.length];
          if (typeCell && typeCell.textContent.includes('Major')) major++;
          else if (typeCell && typeCell.textContent.includes('Minor')) minor++;
        });
        majorCountEl.textContent = major;
        minorCountEl.textContent = minor;
      }

      textarea.addEventListener('paste', e => { e.preventDefault(); textarea.value = e.clipboardData.getData('text'); });
      textarea.addEventListener('dragover', e => e.preventDefault());
      textarea.addEventListener('drop', e => {
        e.preventDefault();
        const dt = e.dataTransfer;
        const text = dt.getData('text');
        if (text) textarea.value = text;
        else if (dt.files.length) {
          const reader = new FileReader();
          reader.onload = ev => textarea.value = ev.target.result;
          reader.readAsText(dt.files[0]);
        }
      });

      parseBtn.addEventListener('click', () => {
        const raw = textarea.value.trim();
        if (!raw) { alert('Please provide log data'); return; }
        tableContainer.innerHTML = '';
        discrepancyContainer.innerHTML = '';

        const lines = raw.split('\n').filter(l => l.trim());
        headers = lines[0].split(/\t/);
        const dataRows = lines.slice(1).map(l => l.split(/\t/));

        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        [...headers, 'Validated', 'Discrepancy'].forEach(h => {
          const th = document.createElement('th'); th.textContent = h; headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        dataRows.forEach(cells => {
          const tr = document.createElement('tr');
          headers.forEach((h, i) => {
            const td = document.createElement('td');
            const val = cells[i] || '';
            if (h === 'CS Page' && val) {
              const puid = cells[headers.indexOf('Puid')];
              const env = cells[headers.indexOf('Environment')];
              const title = cells[headers.indexOf('Title & Year')];
              const url = 'https://admin.nba2k.com/' + env + '/' + title + '/customer_service/user/edit/' + puid + '?titleid=61476&tab=notes';
              const a = document.createElement('a');
              a.textContent = val;
              a.href = '#';
              a.addEventListener('click', () => window.open(url, '_blank', 'noopener,noreferrer,width=800,height=600'));
              td.appendChild(a);
            } else {
              td.textContent = val;
            }
            tr.appendChild(td);
          });
          const validTd = document.createElement('td');
          const validBtn = document.createElement('button'); validBtn.textContent = 'Validated';
          validBtn.addEventListener('click', () => { tr.remove(); updateCounts(); });
          validTd.appendChild(validBtn); tr.appendChild(validTd);

          const discTd = document.createElement('td');
          const discBtn = document.createElement('button'); discBtn.textContent = 'Discrepancy';
          discBtn.addEventListener('click', () => showDiscrepancyForm(tr, cells));
          discTd.appendChild(discBtn); tr.appendChild(discTd);

          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        tableContainer.appendChild(table);
        updateCounts();
      });

      function showDiscrepancyForm(row, cells) {
        const lastTd = row.querySelector('td:last-child');
        if (lastTd.querySelector('select')) return;
        const sel = document.createElement('select');
        discrepancyOptions.forEach(opt => sel.appendChild(new Option(opt, opt)));
        const addBtn = document.createElement('button'); addBtn.textContent = 'Add';
        lastTd.append(sel, addBtn);
        addBtn.addEventListener('click', () => {
          const type = sel.value;
          if (!type) return alert('Select discrepancy type');
          createDiscrepancyRow(cells, type + ' Discrepancy');
          row.remove(); updateCounts();
        });
      }

      function createDiscrepancyRow(cells, typeText) {
        let dtable = discrepancyContainer.querySelector('table');
        if (!dtable) {
          dtable = document.createElement('table');
          const dhead = document.createElement('thead');
          const hdrRow = document.createElement('tr');
          [...headers, 'Type', 'Ticket #', 'Issue', 'Agent Location', 'Other Comments'].forEach(h => {
            const th = document.createElement('th'); th.textContent = h; hdrRow.appendChild(th);
          });
          dhead.appendChild(hdrRow); dtable.appendChild(dhead);
          dtable.appendChild(document.createElement('tbody'));
          discrepancyContainer.appendChild(dtable);
        }
        const dtbody = dtable.querySelector('tbody');
        const tr = document.createElement('tr');
        headers.forEach((h, i) => { const td = document.createElement('td'); td.textContent = cells[i] || ''; tr.appendChild(td); });
        const tdType = document.createElement('td'); tdType.textContent = typeText; tr.appendChild(tdType);
        const tdTicket = document.createElement('td'); const inTicket = document.createElement('input'); inTicket.placeholder = 'Ticket #'; tdTicket.appendChild(inTicket); tr.appendChild(tdTicket);
        const tdIssue = document.createElement('td'); const selIssue = document.createElement('select'); issueOptions.forEach(opt => selIssue.appendChild(new Option(opt, opt))); tdIssue.appendChild(selIssue); tr.appendChild(tdIssue);
        const tdLoc = document.createElement('td'); const selLoc = document.createElement('select'); locationOptions.forEach(opt => selLoc.appendChild(new Option(opt, opt))); tdLoc.appendChild(selLoc); tr.appendChild(tdLoc);
        const tdComm = document.createElement('td'); const inComm = document.createElement('input'); inComm.placeholder = 'Comments'; tdComm.appendChild(inComm); tr.appendChild(tdComm);
        dtbody.appendChild(tr);
      }

      exportBtn.addEventListener('click', () => {
        const table = discrepancyContainer.querySelector('table');
        if (!table) { alert('No discrepancies to export'); return; }
        const rows = Array.from(table.querySelectorAll('tbody tr'));
        const csvRows = [];
        csvRows.push(['Date','Your Name','Agent Name','Agent Location','Major/Minor Discrepancy','Ticket Number','Issue','Other Comments'].join(','));
        const date = new Date().toISOString().split('T')[0];
        rows.forEach(tr => {
          const cols = Array.from(tr.children);
          const agent = cols[3].textContent;
          const type = cols[headers.length].textContent;
          const ticket = cols[headers.length+1].querySelector('input').value;
          const issue = cols[headers.length+2].querySelector('select').value;
          const loc = cols[headers.length+3].querySelector('select').value;
          const comm = cols[headers.length+4].querySelector('input').value;
          csvRows.push([date,'',`"${agent}"`,`"${loc}"`,`"${type}"`,ticket,issue,comm].join(','));
        });
        const blob = new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'discrepancies.csv';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      });
    });
  </script>
</body>
</html>
